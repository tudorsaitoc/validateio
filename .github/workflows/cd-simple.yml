name: Simple CD

on:
  push:
    branches: [ main ]
  workflow_dispatch:

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    steps:
    - uses: actions/checkout@v4
    
    - name: Authenticate to Google Cloud
      uses: google-github-actions/auth@v2
      with:
        credentials_json: ${{ secrets.GCP_SA_KEY }}
    
    - name: Deploy to Cloud Run directly from source
      uses: google-github-actions/deploy-cloudrun@v2
      timeout-minutes: 20
      with:
        service: validateio-backend
        source: ./backend
        region: ${{ secrets.GCP_REGION }}
        env_vars: |
          DATABASE_URL=${{ secrets.DATABASE_URL }}
          SUPABASE_URL=${{ secrets.SUPABASE_URL }}
          SUPABASE_ANON_KEY=${{ secrets.SUPABASE_ANON_KEY }}
          OPENAI_API_KEY=${{ secrets.OPENAI_API_KEY }}
          JWT_SECRET_KEY=${{ secrets.JWT_SECRET_KEY }}
          ENVIRONMENT=production
        flags: --allow-unauthenticated --timeout=900
